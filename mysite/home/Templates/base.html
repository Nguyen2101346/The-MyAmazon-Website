{% load static %}
{% load price_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyAmazon</title> 
    <!--  CSS  -->
    <link href ="{%static 'css/style.css'%}" rel = "stylesheet"/>
    <link href ="{%static 'css/account.css'%}" rel = "stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.min.js" integrity="sha384-RuyvpeZCxMJCqVUGFI0Do1mQrods/hhxYlcVfGPOfQtPJh0JCw12tUAZ/Mv10S7D" crossorigin="anonymous"></script>
    <script type = 'text/javascript'>
        var user = '{{request.user}}'
        {% comment %} <!-- fix csrf cookie --> {% endcomment %}
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
    </script>
</head>
<body>
    <div class="HomeContainer">
        <!-- Header for desktop -->
        <nav class="mainNavbar navbar navbar-expand-lg bg-body-tertiary 
        bg-dark d-none d-lg-flex sticky-top">
            <div class="container-fluid">
                <a class="navbar-brand" href="{% url 'home' %}">MyAmazon</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                 <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="{% url 'home'%}">
                                Trang chủ
                            </a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Sản phẩm
                            </a>
                            <ul class="dropdown-menu p-4" style="min-width: 700px;">
                                <div class="row">
                                    <div class="col-md-3">
                                    {% for category in categories|slice:":20" %}
                                        <li><a class="dropdown-item" href="{% url 'category' %}?cate_id={{category.id}}">{{ category.name }}</a></li>
                                    {% endfor %}
                                    </div>
                                    <div class="col-md-3">
                                    {% for category in categories|slice:"20:40" %}
                                        <li><a class="dropdown-item" href="{% url 'category' %}?cate_id={{category.id}}">{{ category.name }}</a></li>
                                    {% endfor %}
                                    </div>
                                    <div class="col-md-3">
                                    {% for category in categories|slice:"40:60" %}
                                        <li><a class="dropdown-item" href="{% url 'category' %}?cate_id={{category.id}}">{{ category.name }}</a></li>
                                    {% endfor %}
                                    </div>
                                    <div class="col-md-3">
                                    {% for category in categories|slice:"60:" %}
                                        <li><a class="dropdown-item" href="{% url 'category' %}?cate_id={{category.id}}">{{ category.name }}</a></li>
                                    {% endfor %}
                                    </div>
                                </div>
                            </ul>
                        </li>
                    </ul>
                    <ul class="navbar-nav mb-2 mb-lg-0">
                        <!-- Wrapper Search -->
                        <form action="{% url 'search' %}" method="POST" id="searchForm" onsubmit="return validateSearch()">
                            {% csrf_token %}
                            <div class="search-wrapper" id="searchWrapper">
                                <div class="search-box collapsed" id="searchBox">
                                <i class="fa fa-search search-icon" id="searchToggle"></i>
                                <input type="text" id="searchInput" name="searched" placeholder="Tìm kiếm sản phẩm..." oninput="getSuggestions(this.value)">
                                <button type="submit" class="real-search-btn">
                                    <i class="fa fa-search search-icon"></i>
                                </button>
                                </div>
                                <div class="suggestion-box" id="suggestionBox"></div>
                            </div>
                        </form>
                        <li class="cart-icon nav-item">
                            <span class="icon-badge" id="cart-count">{{cartItems}}</span>
                            <a class="nav-link" href="{% url 'cart'%}"><i class="bi bi-cart4"></i></a>
                        </li>
                        
                        {% if user.is_authenticated %}
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    Xin chào! {{request.user}}
                                </a>
                                <ul class="dropdown-menu right">
                                    <li><a class="dropdown-item" href="{% url 'account'%}#profile">Tài khoản</a></li>
                                    <li><a class="dropdown-item" href="{% url 'account'%}#myOrder">Đơn hàng của tôi</a></li>
                                    <li><a class="dropdown-item" href="{% url 'account'%}#wishlist">Yêu thích</a></li>
                                    <li><a class="dropdown-item" href="{% url 'account'%}#history">Đã xem</a></li>
                                    <hr class="dropdown-divider">
                                    <li><a class="dropdown-item" href="{% url 'logout' %}">Đăng xuất</a></li>
                                </ul>
                            </li>
                        {% else %}
                            <!-- Nếu chưa đăng nhập thì hiển thị -->
                            <li class="nav-item">
                                <a class="nav-link" href="#" onclick="window.location.href='/Login/#login-form'">Đăng nhập</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" onclick="window.location.href='/Login/#register-form'">Đăng ký</a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Navbar Mobile (Offcanvas) -->
        <nav class="navbar bg-body-tertiary bg-dark d-lg-none">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'home' %}">MyAmazon</a>
            <button class="btn btn-outline-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu">
            <i class="bi bi-list"></i>
            </button>
        </div>
        </nav>

        <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="mobileMenu">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Menu</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <ul class="navbar-nav">
            <li><a class="nav-link" href="{% url 'home'%}">Trang chủ</a></li>
            <li><a class="nav-link" href="#">Sản phẩm</a></li>
            <li><a class="nav-link" href="{% url 'cart'%}">Giỏ hàng</a></li>
            <li><a class="nav-link" href="{% url 'account'%}">Tài khoản</a></li>
            </ul>
        </div>
        </div>
        <!-- Main body -->
        <main>
            <div id="login-toast" class="login-toast hidden">
                ⚠️ Bạn cần đăng nhập để thực hiện chức năng này!
            </div>
            {% block banner-Slider %}{% endblock banner-Slider %}
            {% block main-content %}{% endblock main-content %}
            {% block recommended_products %}{% endblock recommended_products %}
            <!-- Main body -->
            {% block Myshop-content %}{% endblock Myshop-content %}
            {% block cart-content %}{% endblock cart-content %}
            {% block checkout-content %}{% endblock checkout-content %}
            {% block product-content %}{% endblock product-content %}
            {% block Search-content %}{% endblock Search-content %}
            {% block account-content %}{% endblock account-content%}
            {% block order-content %}{% endblock order-content %}
        </main>
       
        <!-- Footer -->
        <footer class="site-footer">
            <div class="footer-container">
                <div class="footer-column">
                    <h4><strong>MYAmazon</strong>
                    <ul>
                        <li><a href="#">Về chúng tôi</a></li>
                        <li><a href="#">Liên lạc</a></li>
                        <li><a href="#">Các sản phẩm liên quan</a></li>
                        <li><a href="#">Dịch vụ</a></li>
                        <li><a href="#">Thông tin</a></li>
                    </ul>
                </div>

                <div class="footer-column">
                    {% comment %} <h4>ORGANIC BLOCKS</h4>
                    <ul>
                        <li><a href="#">Block Collection</a></li>
                        <li><a href="#">Why Blocks?</a></li>
                        <li><a href="#">ES5 Javascript</a></li>
                        <li><a href="#">View Demos</a></li>
                        <li><a href="#">Documentation</a></li>
                    </ul> {% endcomment %}
                </div>

                <div class="footer-column">
                    {% comment %} <h4>About <strong>MYAmazon</strong>
                    <ul>
                        <li><a href="#">Về chúng tôi</a></li>
                        <li><a href="#">Liên lạc</a></li>
                        <li><a href="#">Các sản phẩm liên quan</a></li>
                        <li><a href="#">Dịch vụ</a></li>
                        <li><a href="#">Thông tin</a></li>
                    </ul> {% endcomment %}
                </div>

                <div class="footer-column mission">
                    <h4>MYAmazon – nơi mua sắm thông minh và tiện lợi</h4>
                    <p>
                        Chúng tôi mang đến trải nghiệm mua sắm trực tuyến đơn giản, dễ tiếp cận nhưng vẫn hiện đại và an toàn.
Mục tiêu của MYAmazon là cung cấp công cụ và nền tảng giúp bạn tìm thấy sản phẩm yêu thích, tiết kiệm thời gian, chi phí và thoát khỏi sự ràng buộc của mua sắm truyền thống.
                    </p>
                    <a class="story-btn" href="#">Hãy xem các sản phẩm của chúng tôi</a>
                </div>
            </div>

            <div class="footer-bottom">
                <div class="footer-brand">
                    <span class="logo">MYAmazon</span>
                    <div class="theme">
                        <p>Copyright © 2023 · All Rights Reserved</p>
                        <p>Theme: <strong>MYAmazon</strong> by <a href="#">Organic Themes</a></p>
                    </div>
                </div>

                <div class="social-icons">
                    <a href="#"><i class="fab fa-tiktok"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-youtube"></i></a>
                    <a href="#"><i class="fas fa-envelope-open-text"></i></a>
                    <a href="#"><i class="fab fa-snapchat-ghost"></i></a>
                    <a href="#"><i class="fab fa-google"></i></a>
                </div>
            </div>
        </footer>
    </div>
    <script src = "{%static 'script/quantityControl.js'%}"></script>
    <script src = "{%static 'script/ChangeIcon.js'%}"></script>
    <script src = "{%static 'script/HiddenControl.js'%}"></script>
    <script src = "{%static 'script/ImgControl.js'%}"></script>
    <script src = "{%static 'script/cart.js'%}"></script>
    <script src = "{%static 'script/wishlist.js'%}"></script>
    <script src="{% static 'js/tab-handler.js' %}"></script>
    <script>
        {% comment %} TOAST {% endcomment %}
        function showLoginToast() {
            const toast = document.getElementById('login-toast');
            toast.classList.remove('hidden');
            toast.classList.add('visible');

            // Ẩn sau 3 giây
            setTimeout(() => {
            toast.classList.remove('visible');
            toast.classList.add('hidden');
            }, 3000);
        }

        document.querySelectorAll('.login-action').forEach(el => {
        el.addEventListener('click', (e) => {
            e.preventDefault();
            const isAuth = el.dataset.authenticated === '1';
            if (!isAuth) {
            showLoginToast();
            } else {
            // Gọi hàm thực tế, ví dụ: addToWishList();
            }
        });
        });

        {% comment %} Tìm kiếm {% endcomment %}
           
            function validateSearch() {
                const input = document.getElementById('searchInput').value.trim();
                if (!input) {
                    Swal.fire({
                    icon: 'warning',
                    title: 'Chưa nhập từ khóa',
                    text: '❗ Vui lòng nhập từ khóa để tìm kiếm.',
                    confirmButtonText: 'OK'
                    });
                    return false; // ❌ Chặn form submit
                }
                return true; // ✅ Cho phép submit
            }
            

          document.addEventListener("DOMContentLoaded", function () {
            const searchBox = document.getElementById("searchBox");
            const searchIcon = document.getElementById("searchToggle");
            const input = document.getElementById("searchInput");
            const suggestionBox = document.getElementById("suggestionBox");
            const searchForm = document.getElementById("searchForm");
            const searchWrapper = document.getElementById("searchWrapper");

            // 👉 Toggle mở rộng
            searchIcon.addEventListener("click", function () {
                if (!searchBox.classList.contains("expanded")) {
                    searchBox.classList.add("expanded");
                    input.focus();
                } else if (input.value.trim() !== "") {
                    searchForm.submit();
                }
            });

            // 👉 Click ngoài searchWrapper
            document.addEventListener("click", function (e) {
                const isClickInside = searchWrapper.contains(e.target);

                if (!isClickInside) {
                    // Nếu đang hiện gợi ý thì chỉ ẩn suggestionBox
                    if (suggestionBox.classList.contains("active")) {
                        suggestionBox.classList.remove("active");
                    }

                    // Nếu input trống và box đang mở thì thu gọn lại
                    if (input.value.trim() === "" && searchBox.classList.contains("expanded")) {
                        searchBox.classList.remove("expanded");
                        searchBox.classList.add("collapsing");

                        setTimeout(() => {
                            searchBox.classList.remove("collapsing");
                            input.value = "";
                            suggestionBox.innerHTML = "";
                        }, 300);
                    }
                }
            });

            // 👉 Gợi ý sản phẩm
            input.addEventListener("input", function () {
                const query = this.value.trim();
                getSuggestions(query);
            });

            function getSuggestions(query) {
                if (query.length === 0) {
                    suggestionBox.classList.remove("active");
                    suggestionBox.innerHTML = "";
                    return;
                }

                fetch(`/api/suggestions/?q=${encodeURIComponent(query)}`)
                    .then(res => {
                        if (!res.ok) throw new Error("Network error");
                        return res.json();
                    })
                    .then(data => {
                        suggestionBox.innerHTML = "";

                        if (data.length === 0) {
                            suggestionBox.classList.remove("active");
                            return;
                        }

                        data.forEach(product => {
                            const link = document.createElement("a");
                            link.href = `/product/?id=${product.id}`;
                            link.className = "suggestion-item";

                            let priceHtml = '';

                            if (product.old_price) {
                                priceHtml = `
                                    <span class="old-price">${product.old_price}</span>
                                    <span class="new-price">${product.new_price}</span>
                                `;
                            } else {
                                priceHtml = `
                                    <span class="new-price">${product.new_price}</span>
                                `;
                            }

                            link.innerHTML = `
                                <img src="${product.image}" alt="${product.name}">
                                <div class='suggestion-right'>
                                    <span class="suggestion-name clamp-2">${product.name}</span>
                                    <span class="suggestion-price">
                                        ${priceHtml}
                                    </span>
                                </div>
                            `;

                            suggestionBox.appendChild(link);
                        });

                        suggestionBox.classList.add("active");
                    })
                    .catch(err => {
                        console.error("❌ Error fetching suggestions:", err);
                        suggestionBox.classList.remove("active");
                        suggestionBox.innerHTML = "";
                    });
            }
        });
    </script>
</body>
</html>