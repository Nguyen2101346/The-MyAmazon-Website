{% extends "base.html" %}
{% load static %}
{% load price_filters %}
{% load crispy_forms_tags %}
{% load countries %} {# Load django-countries template tags #}
{% block checkout-content %}

{% if messages %}
<div class="container mt-3">
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
</div>
{% endif %}
{% if order_success %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var successModal = new bootstrap.Modal(document.getElementById('successModal'));
    successModal.show();
  });
</script>
{% endif %}

<div class="Checkout Container">
    <h1><strong>Thanh to√°n</strong></h1>
    <form action="" method="POST">
        {% csrf_token %}
        <div class="Main-Content">
            <div class="card flex-fill">
                <div class="content Contact-inf">
                    <div class="card-title">
                        <h2><strong>Th√¥ng tin li√™n l·∫°c</strong></h2>
                    </div>
                    <div class="contrucstion">
                        <p>Ch√∫ng t√¥i s·∫Ω s·ª≠ d·ª•ng email n√†y ƒë·ªÉ g·ª≠i b·∫°n nh·ªØng thay ƒë·ªïi trong ƒë∆°n h√†ng c·ªßa b·∫°n.</p>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="email" name="email" class="form-control" id="InputEmail1" placeholder="name@example.com" required>
                        <label for="InputEmail1">ƒê·ªãa ch·ªâ Email</label>
                        <div id="emailHelp" class="form-text">H√£y s·ª≠ d·ª•ng ƒë·ªãa ch·ªâ email hi·ªán t·∫°i c·ªßa b·∫°n.</div>
                    </div>
                </div>
                <div class="content Billing-address">
                    <div class="card-title">
                        <h2><strong>ƒê·ªãa ch·ªâ nh·∫≠n h√†ng</strong></h2>
                    </div>
                    <div class="contrucstion">
                        <p>H√£y th√™m ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªãa ch·ªâ nh·∫≠n h√†ng ƒë·ªÉ tr√°nh c√°c s·ª± c·ªë trong l√∫c v·∫≠n chuy·ªÉn</p>
                    </div>
                    <div class="form-floating mb-3">
                       {% csrf_token %}
                        {{ country_form.country|as_crispy_field }}
                    </div>
                    <div class="Input-row mb-3">
                        <div class="form-floating mb-3">
                            <input type="text" name="lastname" id="InputLName" class="form-control" placeholder="Last Name" required>
                            <label for="InputLName">H·ªç</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" name="firstname" id="InputFName" class="form-control" placeholder="First Name" required>
                            <label for="InputFName">T√™n</label>
                        </div>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" name="address" id="InputAddress" class="form-control" placeholder="Address" required>
                        <label for="InputAddress" class="form-label">ƒê·ªãa ch·ªâ (T√™n ƒë∆∞·ªùng, ph∆∞·ªùng, qu·∫≠n,....)</label>
                    </div>
                    <div class="AddApartment mb-3">
                        <a href="#" id="toggleApartment"> + Th√™m s·ªë cƒÉn h·ªô, t·∫ßng ·ªü chung c∆∞ (n·∫øu c√≥) </a>
                        <div id="apartmentForm" class="form-floating mb-3" style="display: none;">
                            <input type="text" name="apartmentaddress" id="InputApartment" class="form-control" placeholder="Apartment">
                            <label for="InputApartment" class="form-label">S·ªë cƒÉn,t·∫ßng</label>
                        </div>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" name="city" id="InputCity" class="form-control" placeholder="City" required>
                        <label for="InputCity" class="form-label">Th√†nh ph·ªë</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" name="phone" id="InputPhone" class="form-control" placeholder="Phone" required>
                        <label for="InputPhone" class="form-label">ƒêi·ªán tho·∫°i</label>
                    </div>
                </div>
                <div class="content Payment-opt">
                    <div class="card-title">
                        <h2><strong>Ph∆∞∆°ng th·ª©c thanh to√°n</strong></h2>
                    </div>
                    <br>
                    <div class="PaymentMethod">
                        <div class="form-floating mb-3">
                            <select class="form-select" name="payment_method" id="paymentMethod">
                                <option value="amz">AmzLayter</option>
                                <option value="viettin">Ng√¢n h√†ng Viettinbank</option>
                                <option value="cash" selected>Tr·∫£ sau khi nh·∫≠n h√†ng</option>
                            </select>
                            <label for="paymentMethod">Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</label>
                        </div>
                    </div>
                    <div class="mt-5 mb-3 custom-checkbox">
                        <input type="checkbox" id="noteCheckbox">
                        <label for="noteCheckbox">Th√™m ghi ch√∫ cho ƒë∆°n h√†ng c·ªßa b·∫°n</label>
                        <div id="noteTextarea" class="mt-2">
                            <textarea class="form-control" name="note" placeholder="ƒê·ªÉ l·∫°i ghi ch√∫ ·ªü ƒë√¢y" id="floatingNote" style="height: 100px;"></textarea>
                        </div>
                    </div>
                </div>
                <div class="content Input-row Control-btn">
                    <a href="{% url 'cart' %}" class="btn-return">
                        &#x2190; Quay l·∫°i gi·ªè h√†ng
                    </a>
                    <button type="submit" class="btn placeOrder">
                        ƒê·∫∑t h√†ng ngay
                    </button>
                </div>
            </div>
            <div class="Order-Sumary SubContainer flex-fill">
                <div class="card">
                    <div class="card-title">
                        <h3>Chi ti·∫øt ƒë∆°n h√†ng</h3>
                    </div>
                    <hr>
                    <div class="card-content">
                          {% for item in items %}
                            <div class="item-card">
                                <div class="item-img">
                                <span class="badge">{{ item.quantity }}</span>
                                <img src="{{ item.product.ImageUrl }}" alt="" class="rounded">
                                </div>
                                <div class="item-content">
                                <div class="card-title">
                                    <h3>{{ item.product.name }}</h3>
                                </div>
                                <div class="card-span">
                                    {% if item.get_discounted_total < item.get_total %}
                                        <span class="old-price" style="text-decoration: line-through; color: gray;">
                                            {{ item.get_total|format_price }}
                                        </span>
                                        <span class="price text-danger fw-bold">
                                            {{ item.get_discounted_total|format_price }}
                                        </span>
                                        <div class="sale">Gi·∫£m {{ item.get_discount_amount|format_price }}</div>
                                    {% else %}
                                        <span class="price">{{ item.get_total|format_price }}</span>
                                    {% endif %}
                                </div>
                                <div class="card-p">
                                    <p>{{ item.product.description|truncatewords:15 }}</p>
                                </div>
                                </div>
                                <div class="item-price">
                                <div class="card-span">
                                    <span class="fw-bold">{{ item.get_discounted_total|format_price }}</span>
                                </div>
                                </div>
                            </div>
                            {% endfor %}
                    </div>
                    <hr>
                    <div class="Subtotal row">
                        <h4 class="col">T·∫°m t√≠nh</h4>
                        <span class="col">{{ order.get_cart_total|format_price }}</span>
                    </div>
                    <hr>
                    <div class="Total mb-3 row">
                        <h4 class="col">T·ªïng ti·ªÅn</h4>
                        <span class="col">{{ order.get_cart_total|format_price }}</span>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title w-100" id="successModalLabel">üéâ ƒê·∫∑t H√†ng Th√†nh C√¥ng!</h5>
      </div>
      <div class="modal-body">
        <p>C·∫£m ∆°n b·∫°n ƒë√£ ƒë·∫∑t h√†ng! Ch√∫ng t√¥i s·∫Ω s·ªõm li√™n h·ªá ƒë·ªÉ giao h√†ng.</p>
      </div>
      <div class="modal-footer justify-content-center">
        <a href="{% url 'cart' %}" class="btn btn-success">OK</a>
      </div>
    </div>
  </div>
</div>
{% endblock checkout-content %}
