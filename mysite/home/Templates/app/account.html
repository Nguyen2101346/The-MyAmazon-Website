{% extends "base.html" %}
{% load static %}
{% load tz %}
{% load price_filters %}
{% load detail_tags %}
{% block account-content %}

<form action="/update-profile" method="POST" enctype="multipart/form-data">
<div class="account Container">
    <!-- N·∫øu b·∫°n d√πng Django -->
    {% csrf_token %}
  <div class="accountleft rounded-left">
    <div class="Avatar" id="avatarBox">
      <div class="img" id="avatarPreview">
        {% if user.profile.avatar %}
          <img src="{{ user.profile.avatar.url }}" alt="avatar" id="avatarImage">
        {% else %}
          <img src="{% static 'img/baseAvt.jpg' %}" alt="avatar" id="avatarImage">
        {% endif %}
        <div class="change-btn" id="changeBtn">
          <span class="plus">Ôºã</span>
          <span class="text">Change</span>
          <input type="file" accept="image/*" id="avatarInput" name="avatar" hidden>
        </div>
      </div>
    </div>
    <div class="tabs">
      <div class="tab" data-target="profile">T√†i kho·∫£n <span class="arrow">‚Ä∫</span></div>
      <div class="tab" data-target="myOrder">ƒê∆°n h√†ng c·ªßa t√¥i <span class="arrow">‚Ä∫</span></div>
      <div class="tab" data-target="wishlist">Y√™u th√≠ch ({{ wishlist|length }})<span class="arrow">‚Ä∫</span></div>
      <div class="tab" data-target="history">ƒê√£ xem <span class="arrow">‚Ä∫</span></div>
    </div>
  </div>
  <div class="accountright rounded-right">
    <div class="tab-content active" id="profile">
      <h2 class="text-2xl font-bold mb-4∆∞\">Th√¥ng tin c√° nh√¢n</h2>
    
        <div class="fullnamme">
          <div class="mb-4 form-floating">
            <input type="text" name="InputLastName" id="InputLastName" value="{{user.last_name}}" class="form-control" placeholder="H·ªç">
            <label for="InputLastName" class="form-label">H·ªç</label>
          </div>
          <div class="mb-4 form-floating">
            <input type="text" name="InputFirstName" id="InputFirstName" value="{{user.first_name}}" class="form-control" placeholder="T√™n">
            <label for="InputFirstName" class="form-label">T√™n</label>
          </div>
        </div>
  
        <div class="mb-4 form-floating">
          <input type="email" name="email" id="InputEmail" value="{{ user.email }}" class="form-control" placeholder="Email">
          <label for="InputEmail" class="form-label">Email</label>
        </div>
    
        <div class="mb-4 form-floating">
          <input type="text" name="username" id="username" value="{{ user.username }}" class="form-control" placeholder="T√†i kho·∫£n">
          <label for="username" class="form-label">T√†i kho·∫£n</label>
        </div>
        
        {% if user.profile.phone %}
        <div class="mb-4 form-floating">
          <input type="text" name="InputPhone" id="phone" value="{{ user.profile.phone }}" class="form-control" placeholder="S·ªë ƒëi·ªán tho·∫°i">
          <label for="InputPhone" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
        </div>
        {% else %}
        <div class="mb-4 form-floating">
          <input type="text" name="InputPhone" id="phone" value="" class="form-control" placeholder="S·ªë ƒëi·ªán tho·∫°i">
          <label for="InputPhone" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
        </div>
        {% endif %}
        
        {% if user.profile.address %}
        <div class="mb-4 form-floating">
          <input type="text" name="InputAddress" id="address" value="{{ user.profile.address }}" class="form-control" placeholder="ƒê·ªãa ch·ªâ">
          <label for="InputAddress" class="form-label">ƒê·ªãa ch·ªâ</label>
        </div>
        {% else %}
        <div class="mb-4 form-floating">
          <input type="text" name="InputAddress" id="address" value="" class="form-control" placeholder="ƒê·ªãa ch·ªâ">
          <label for="InputAddress" class="form-label">ƒê·ªãa ch·ªâ</label>
        </div>
        {% endif %}
        <div class="text-right">
          <button type="submit" class="btn ">
            L∆∞u thay ƒë·ªïi
          </button>
        </div>
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-success mt-4">{{ message }}</div>
          {% endfor %}
        {% endif %}
      </div>
      <div class="tab-content" id="myOrder">
        <h2>ƒê∆°n h√†ng c·ªßa t√¥i</h2>
        {% if orders %}
          {% for order in order_page_obj %}
            <div class="card mb-4 shadow-sm p-3">
              <div class="order-top">
                <div class='title'>
                  <h5>üßæ Order #{{ order.id }}  <span class="order-date">ƒê√£ ƒë·∫∑t: {{ order.date_Order|date:"l, d F Y" }}</span></h5>
                </div> 
                {# Hi·ªÉn th·ªã ƒë·ªãa ch·ªâ t·ª´ ShippingAddress #}
                <div class="order-info">
                  {% if order.shipping %}
                    <p class="order-address">ƒê·ªãa ch·ªâ: {{ order.shipping.address }}, {{ order.shipping.city }}, {{ order.shipping.country.name }}</p>
                  {% endif %}

                  <div class="order-state">
                    {% if order.shipping_status == 'delivered' %}
                      <span class="badge success">ƒê√£ ho√†n th√†nh</span>
                    {% elif order.shipping_status == 'processing' %}
                      <span class="badge bg-primary">ƒêang x·ª≠ l√Ω</span>
                    {% elif order.shipping_status == 'cancelled' %}
                      <span class="badge bg-danger">ƒê√£ h·ªßy</span>
                    {% else %}
                      <span class="badge warning text-dark">ƒêang giao</span>
                    {% endif %}
                  </div>
                </div>
                {% if shipping.note %}
                  <p class="order-note">Ghi ch√∫: {{ shipping.note }}</p>
                {% endif %}
              </div>
              <hr>

              {# Hi·ªÉn th·ªã s·∫£n ph·∫©m #}
              <div class="product-list">
                {% for item in order.orderitem_set.all %}
                  {% if forloop.counter <= 4 %}
                    <div class="d-flex mb-2">
                      {% if item.product.ImageUrl %}
                            <img src="{{ item.product.ImageUrl }}" 
                                alt="{{ item.product.name }}" 
                                style="max-height: 100%; max-width: 100%; object-fit: contain;">
                        {% else %}
                            <img src="{% static 'img/nothing.jpg' %}" 
                                alt="No image available" 
                                style="max-height: 100%; max-width: 100%; object-fit: contain;">
                        {% endif %}
                      <div>
                        <strong>{{ item.product.name }}</strong><br>

                        {% if item.product.get_discounted_price < item.product.price %}
                          <span class="price">
                            <span class="old-price text-muted text-decoration-line-through">{{ item.product.price|format_price }}</span>
                            <span class="new-price text-danger fw-bold me-2">{{ item.product.get_discounted_price|format_price }}</span>
                              √ó {{ item.quantity }} = 
                            <strong>{{ item.get_discounted_total|format_price }}</strong>
                          </span>
                        {% else %}
                          <span class="price">
                            <span class="new-price me-2">{{ item.product.get_discounted_price|format_price }}</span>
                             √ó {{ item.quantity }} = 
                            <strong>{{ item.get_total|format_price }}</strong>
                          </span>
                        {% endif %}

                      </div>
                    </div>
                  {% else %}
                    <div class="extra-wrapper extra-{{ order.id }}">
                      <div class="extra-product d-flex mb-2">
                        {% if product.ImageUrl %}
                            <img src="{{ item.product.ImageUrl }}" 
                                alt="{{ item.product.name }}" 
                                style="max-height: 100%; max-width: 100%; object-fit: contain;">
                        {% else %}
                            <img src="{% static 'img/nothing.jpg' %}" 
                                alt="No image available" 
                                style="max-height: 100%; max-width: 100%; object-fit: contain;">
                        {% endif %}
                        <div>
                          <strong>{{ item.product.name }}</strong><br>

                          {% if item.product.get_discounted_price < item.product.price %}
                            <span class="price">
                              <span class="old-price text-muted text-decoration-line-through me-2">{{ item.product.price|format_price }}</span>
                              <span class="new-price text-danger fw-bold me-2">{{ item.product.get_discounted_price|format_price }}</span>
                               √ó {{ item.quantity }} = 
                              <strong>{{item.get_discounted_total|format_price }}</strong>
                            </span>
                          {% else %}
                            <span class="price">
                              <span class="new-price me-2">{{ item.product.get_discounted_price|format_price }}</span>
                               √ó {{ item.quantity }} = 
                              <strong>{{ item.get_total|format_price }}</strong>
                            </span>
                          {% endif %}

                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}

                {% if order.orderitem_set.count > 4 %}
                  <div class="more-toggle-container">
                    <div class="more-toggle-btn arrow-down" onclick="toggleExtraProducts('{{ order.id }}', this)">
                      <span class="label">Xem th√™m</span>
                    </div>
                  </div>
                {% endif %}
              </div>

              <hr>
              <div class="order-bot text-end">
                {% if order.shipping_status != 'delivered' %}
                  <div class="text-end mt-2">
                    <a href="{% url 'confirm-received' order.id %}" class="btn greenbase">
                      ƒê√£ nh·∫≠n h√†ng
                    </a>
                  </div>
                {% elif order.shipping_status == 'delivered' %}
                  <div class="text-end mt-2">
                    <p class="btn-success">
                      ‚úÖ T√¥i ƒë√£ nh·∫≠n h√†ng
                    </p>
                  </div>
                {% endif %}
                
                <strong>üßÆ T·ªîNG: ${{ order.get_cart_total }}</strong>
              </div>
            </div>
          {% endfor %}
        {% else %}
        <div class="notice-empty">
          <p>B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o ƒë∆∞·ª£c ƒë·∫∑t.</p>
        </div>
        {% endif %}
        {% include "pagination.html" with page_obj=order_page_obj page_param="order_page" id="myOrder" %}
      </div>
      <div class="tab-content" id="wishlist">
        <h2>S·∫£n ph·∫©m y√™u th√≠ch</h2>
        <div class="wishlist-list">
          {% for item in wishlist_page_obj %}
            <div class="history-item mb-4">
              <a href="{% url 'product' %}?id={{ item.product.id }}">
                {% if item.product.ImageUrl %}
                      <img src="{{ item.product.ImageUrl }}" 
                          alt="{{ item.product.name }}" 
                          style="max-height: 100%; max-width: 100%; object-fit: contain;">
                  {% else %}
                      <img src="{% static 'img/nothing.jpg' %}" 
                          alt="No image available" 
                          style="max-height: 100%; max-width: 100%; object-fit: contain;">
                {% endif %}
              </a>
              <div class="historyitem-right">
                <div class="title">
                  <a href="{% url 'product' %}?id={{ item.product.id }}">
                    <h4>{{ item.product.name }}</h4>
                  </a>
                  <div class="info-control">
                        <div class="add wishlist-btn" data-product="{{ item.product.id }}">
                          <i class="fa-solid fa-heart wishlist-icon {% if item.product in user_wishlist %}active shake{% endif %}"></i>
                        </div>
                  </div>
                </div>
                <div class="rating">
                    {% for i in "12345" %}
                        {% if forloop.counter <= item.product.average_rating %}
                        <span style="color: gold;">&#9733;</span>  {# ng√¥i sao ƒë·∫ßy #}
                        {% elif forloop.counter <= item.product.average_rating|add:"0.5" %}
                        <span style="color: gold;">&#9734;</span>  {# ng√¥i sao n·ª≠a ƒë·∫ßy n·∫øu mu·ªën #}
                        {% else %}
                        <span style="color: lightgray;">&#9733;</span>  {# ng√¥i sao r·ªóng #}
                        {% endif %}
                    {% endfor %}
                    <span>({{ item.product.average_rating }})</span>
                </div>
                {% if item.product.get_discounted_price < item.product.price %}
                    <div class="price">
                        <span class="old-price">
                            ${{ item.product.price}}
                        </span>
                        <span class="new-price">
                            ${{ item.product.get_discounted_price|floatformat:2 }}
                        </span>
                    </div>
                    {% else %}
                    <div class="price">
                        <span class="new-price">
                            ${{ item.product.get_discounted_price|floatformat:2 }}
                        </span>
                    </div>
                {% endif %}
              </div>
            </div>
          {% empty %}
          <div class="notice-empty">
            <p>B·∫°n ch∆∞a th√≠ch s·∫£n ph·∫©m n√†o. H√£y kh√°m ph√° c·ª≠a h√†ng ch√∫ng t√¥i, s·∫Ω c√≥ r·∫•t nhi·ªÅu nh·ªØng s·∫£n ph·∫©m b·∫°n y√™u th√≠ch ƒë√≥.</p>
          </div>
          {% endfor %}
          {% include "pagination.html" with page_obj=wishlist_page_obj page_param="wishlist_page" id="wishlist" %}
        </div>
      </div>
      <div class="tab-content" id="history">
        <h2>L·ªãch s·ª≠ ƒë√£ xem</h2>
        <div class="history-list">
          {% for record in history_page_obj %}
            <div class="history-item mb-4">
              <a href="{% url 'product' %}?id={{ record.product.id }}">
                {% if record.product.ImageUrl %}
                    <img src="{{ record.product.ImageUrl }}" 
                        alt="{{ record.product.name }}" 
                        style="max-height: 100%; max-width: 100%; object-fit: contain;">
                {% else %}
                    <img src="{% static 'img/nothing.jpg' %}" 
                        alt="No image available" 
                        style="max-height: 100%; max-width: 100%; object-fit: contain;">
                {% endif %}
              </a>
              <div class="historyitem-right">
                <div class="title">
                  <a href="{% url 'product' %}?id={{ record.product.id }}">
                    <h4>{{ record.product.name }}</h4>
                  </a>
                  <small>ƒê√£ xem l√∫c: {{ record.viewed_at|localtime|date:"H:i d/m/Y" }}</small>
                </div>
                <div class="rating">
                    {% for i in "12345" %}
                        {% if forloop.counter <= record.product.average_rating %}
                        <span style="color: gold;">&#9733;</span>  {# ng√¥i sao ƒë·∫ßy #}
                        {% elif forloop.counter <= record.product.average_rating|add:"0.5" %}
                        <span style="color: gold;">&#9734;</span>  {# ng√¥i sao n·ª≠a ƒë·∫ßy n·∫øu mu·ªën #}
                        {% else %}
                        <span style="color: lightgray;">&#9733;</span>  {# ng√¥i sao r·ªóng #}
                        {% endif %}
                    {% endfor %}
                    <span>({{ record.product.average_rating }})</span>
                </div>
                {% if record.product.get_discounted_price < record.product.price %}
                    <div class="price">
                        <span class="old-price">
                            ${{ record.product.price}}
                        </span>
                        <span class="new-price">
                            ${{ record.product.get_discounted_price|floatformat:2 }}
                        </span>
                    </div>
                    {% else %}
                    <div class="price">
                        <span class="new-price">
                            ${{ record.product.get_discounted_price|floatformat:2 }}
                        </span>
                    </div>
                {% endif %}
              </div>
            </div>
          {% empty %}
            <div class="notice-empty">
              <p>B·∫°n ch∆∞a xem s·∫£n ph·∫©m n√†o.</p>
            </div>
          {% endfor %}
          {% include "pagination.html" with page_obj=history_page_obj page_param="history_page" id="history" %}
        </div>
      </div>
    </div>
  </div>
</form>
<!-- profile.html -->


<script>
document.addEventListener("DOMContentLoaded", function () {
  const tabs = document.querySelectorAll('.tab');
  const contents = document.querySelectorAll('.tab-content');

  // Click handler cho c√°c tab
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const targetId = tab.getAttribute('data-target');
      activateTab(targetId);

      // C·∫≠p nh·∫≠t hash tr√™n URL
      history.replaceState(null, null, `#${targetId}`);
    });
  });

  // H√†m chuy·ªÉn tab
  function activateTab(targetId) {
    // X√≥a active c≈©
    tabs.forEach(t => t.classList.remove('active'));
    contents.forEach(c => c.classList.remove('active'));

    // G√°n active
    const activeTab = [...tabs].find(t => t.dataset.target === targetId);
    const activeContent = document.getElementById(targetId);

    if (activeTab && activeContent) {
      activeTab.classList.add('active');
      activeContent.classList.add('active');
    }
  }

  // Khi trang load: check hash
  const initialHash = window.location.hash.substring(1);
  if (initialHash) {
    activateTab(initialHash);
  } else {
    // M·∫∑c ƒë·ªãnh tab ƒë·∫ßu ti√™n
    const defaultTarget = tabs[0]?.getAttribute('data-target');
    if (defaultTarget) activateTab(defaultTarget);
  }
});

function toggleExtraProducts(orderId, button) {
  const wrappers = document.querySelectorAll(`.extra-${orderId}`);
  const label = button.querySelector('.label');

  const isShowing = wrappers[0].classList.contains('show');

  wrappers.forEach(wrap => {
    wrap.classList.toggle('show', !isShowing);
  });

  if (isShowing) {
    button.classList.remove('arrow-up');
    button.classList.add('arrow-down');
    label.textContent = 'Xem th√™m';
  } else {
    button.classList.remove('arrow-down');
    button.classList.add('arrow-up');
    label.textContent = '·∫®n b·ªõt';
  }
}
</script>

{% endblock account-content %}